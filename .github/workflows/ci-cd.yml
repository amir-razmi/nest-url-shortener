name: CI/CD Pipeline
on:
  push:
    branches: [main, 'dev']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Clone Repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Prepare test environment variables
        run: |
          cp .example-test.env .env

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Run Test DBs
        run: docker compose -f docker-compose.test.yaml up -d

      - name: Sleep
        run: |
          sleep 10

      - name: Prisma generate
        run: npx prisma generate

      - name: Prisma db push
        run: npx prisma db push

      - name: Run Integration tests
        run: pnpm test:int:ci

      - name: Stop test databases
        if: always()
        run: docker compose -f docker-compose.test.yaml down

  run-application:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create production environment file
        run: |
          cat > .env << EOF
          NODE_ENV=${{ vars.NODE_ENV }}
          PORT=${{ vars.PORT }}
          CORS=${{ vars.CORS }}
          REDIS_HOST=${{ vars.REDIS_HOST }}
          REDIS_PORT=${{ vars.REDIS_PORT }}
          MONGODB_DATABASE=${{ vars.MONGODB_DATABASE }}
          MONGODB_USERNAME=${{ vars.MONGODB_USERNAME }}
          MONGODB_ROOT_USER=${{ vars.MONGODB_INITIAL_PRIMARY_ROOT_USER }}
          MONGODB_REPLICA_SET_NAME=${{ vars.MONGODB_REPLICA_SET_NAME }}
          MONGODB_INITIAL_PRIMARY_ROOT_USER=${{ vars.MONGODB_INITIAL_PRIMARY_ROOT_USER }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASS=${{ secrets.SMTP_PASS }}
          EMAIL_FROM=${{ secrets.EMAIL_FROM }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          MONGODB_PASSWORD=${{ secrets.MONGODB_PASSWORD }}
          MONGODB_ROOT_PASSWORD=${{ secrets.MONGODB_ROOT_PASSWORD }}
          MONGODB_REPLICA_SET_KEY=${{ secrets.MONGODB_REPLICA_SET_KEY }}
          MONGODB_INITIAL_PRIMARY_ROOT_PASSWORD=${{ secrets.MONGODB_ROOT_PASSWORD }}
          EOF

      - name: log the .env file
        run: cat .env

      - name: Stop existing containers
        run: docker compose down || true

      - name: Build and start services
        run: docker compose up -d --build

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be healthy..."
          timeout 120 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 5; done' || true
          docker compose ps

      - name: Run health check
        run: |
          sleep 10
          curl -f http://localhost:${{ vars.PORT }}/api-doc || echo "Health check endpoint not available"

      - name: Show logs on failure
        if: failure()
        run: docker compose logs

      - name: Shutdown stack
        if: always()
        run: docker compose down -v
